<?php
defined('SYSPATH') or die('No direct script access.');

/**
 * Created by PhpStorm.
 * User: chunyu
 * Date: 18/01/15
 * Time: 下9:25
 *
 * App端首页
 *
 */
class Controller_Ver1_AppHome extends AppCore
{
    protected $_check_token = false;
    protected $_check_user = false;

    protected $note_repay_order_day = 7;
    protected $button_enable = 1;
    protected $button_disable = 0;
    protected $button_type_loan = 'loan';
    protected $button_type_repay = 'repay';

    protected $response_array = [];
    public $redis_hash;
    public $model;


    protected $tester = [505471, 722030, 153, 3459566, 3459513];

    public function before()
    {
        parent::before(); // TODO: Change the autogenerated stub
        $this->model['user'] = Model::factory('User');
        $this->model['order'] = Model::factory('Order');


        $this->common();

        //标记今天第一次登录
        if (App::$_token['user_id'] > 0) {
            $this->redis_hash = Redis_Hash::instance();
            $key = 'app_flag_first_login' . date('m-d-H');
            if (App::$_token['user_id'] > 0 && !$this->redis_hash->exists_field($key, App::$_token['user_id']) && $this->redis_hash->set($key, App::$_token['user_id'], 1)) {
                $this->redis_hash->expire($key, 600);
            }
        }
        //打开app就弹窗
        /*if (isset(App::$_user['id']) && App::$_user['id'] > 0) {
            $tcoa = Lib::factory('AC_Note');
            if ($tcoa->is_during_ac(App::$_user['id'])) {
                Model::factory('JPush_Queue')->push_message_by_alias('JPUSH_note', ['user_id' => App::$_user['id'], 'mobile' => App::$_user['mobile']]);
            }
        }*/


    }


    public function action_Index()
    {
        $this->response_json($this->response_array, '1000', '查询成功');
    }


    public function action_Android()
    {
        $this->response_json($this->response_array, '1000', '查询成功');

    }


    public function action_IOS()
    {
        $this->response_json($this->response_array, '1000', '查询成功');

    }


    public function action_Wechat()
    {
        $this->response_json($this->response_array, '1000', '查询成功');
    }


    protected function common()
    {
        //ad 公告
        $notice = '';
        $notice_url = '';
        $bannerModel = Model::factory('AD');
        $bannerData = $bannerModel->getNotice(1, [Model_AD::ALL_APP_ID, App::$id]);//type 为 1
        if ($bannerData) {
            $notice = $bannerData['subject'];
            $notice_url = $bannerData['target'];
        }
        unset($bannerModel, $bannerData);

        //未登录 未授信
        $info = [
            'logo' => '',//'http://a-cdn.timecash.cn/banner/grzx/bank_card.png',//logo和name app端选择一个，返回时另一个为空
            'name' => $this->_env['app_name'],
            'title' => '最高可借(元)',
            'button_title' => '立即授信',
            'button_url' => 'app://app.inst/CreditInfo/List',
            'button_enable' => '0', //是否可点击
            'notice' => $notice, //公告
            'notice_url' => $notice_url, //公告链接
            'max_amount' => '100000', //最大金额
            'available_amount' => '0', //可用金额
            'credit_auth' => '0',
            'sub_info' => '', //显示信息
            'has_overdue_order' => '0', //显示信息
        ];

        //初始值
        $order = [];
        $popup = [];
        if (isset(App::$_token['user_id']) && App::$_token['user_id'] > 0) {//已登录

            //是否有订单 , 授信完成后50天未下单，重新授信
            if((int)App::$_user['credit_auth'] == Model_User::CREDIT_AUTH_BASE_VERIFIED){
                $order_num = $this->model['order']->getCountByArray(['user_id' => App::$_token['user_id']], 1);
                if($order_num == 0){
                    $pass_time = Model::factory('User_Audit')->getPassTime(App::$_token['user_id']);
                    if($pass_time > 0 && $pass_time < (time() - Model_User_Audit::PASS_VALIDITY_TIME)){
                        $this->model['user']->update($this->user_id, [
                            'credit_auth' => Model_User::CREDIT_AUTH_BASE_READY,
                        ]);
                        Model::factory('CreditInfo_Step')->overdueModel(App::$_token['user_id']);
                        App::$_user['credit_auth'] = Model_User::CREDIT_AUTH_BASE_READY;
                    }
                }
            }


            $info['credit_auth'] = (string)App::$_user['credit_auth'];
            if ((int)App::$_user['allow_login'] !== (int)Model_User::ALLOW_LOGIN__ALLOWED ||
                in_array(App::$_user['status'], [Model_User::STATUS_DENY, Model_User::STATUS_LOANDENY, Model_User::STATUS_DENYFOREVER, Model_User::STATUS_DENYTEMP, Model_User::STATUS_DELETED])
            ) {
                $info['button_title'] = '未通过';
                $info['button_url'] = '';
            }


            if (in_array((int)App::$_user['credit_auth'], [Model_User::CREDIT_AUTH_BASE_ONSUBMIT, Model_User::CREDIT_AUTH_BASE_SUBMITED, Model_User::CREDIT_AUTH_BASE_CHECKING])) {
                $info['button_title'] = '审核中';
                $info['button_url'] = '';
            } elseif ((int)App::$_user['credit_auth'] == Model_User::CREDIT_AUTH_BASE_FAILED) {
                //授信未通过, available_amount=0提示额度不足
                $info['button_title'] = '立即借款';
                $info['button_url'] = 'app://app.inst/Inst/Start';
                $info['button_enable'] = '1';
                $info['max_amount'] = 0;
                $info['available_amount'] = 0;
            } elseif ((int)App::$_user['credit_auth'] == Model_User::CREDIT_AUTH_BASE_BACK) {
                $info['button_title'] = '授信未通过';
                $info['button_url'] = 'app://app.inst/CreditInfo/List';

            } elseif ((int)App::$_user['credit_auth'] == Model_User::CREDIT_AUTH_BASE_VERIFIED) {
                //授信通过
                $info['button_title'] = '立即借款';
                $info['button_url'] = 'app://app.inst/Inst/Start';
                $info['button_enable'] = '1';

            }


            //额度
            $fp = $this->model['user']->get_finance_profile(App::$_token['user_id']);
            if ($fp) {
                if (isset($fp['inst_amount'])) {
                    $info['max_amount'] = (string)intval($fp['inst_amount']) . '';
                }
                $total_loan_amount = $this->model['order']->unfinishedAmount(App::$_token['user_id']);
                $info['available_amount'] = (string)intval(bcsub($info['max_amount'], $total_loan_amount, 2));
                $info['available_amount'] > 0 ? '' : $info['available_amount'] = '0';

            }
            if($info['available_amount'] < 1000){
                $info['button_enable'] = '0';
                $info['sub_info'] = '提现额度不足';
                $popup = [
                    'title' => '提示',
                    'msg' => '提现额度不足',
                    'popup_left' => '',
                    'popup_right' => '确定',
                    'url' => '',
                ];
            }
            unset($fp);


            //未完成订单
            $overdue_order_id = 0;
            $order = $this->model['order']->getNeedRepay(App::$_token['user_id']);
            $overdue_num = 0;
            $need_repay_num = 0;
            if ($order && count($order) > 0) {
                foreach ($order as $k => $o) {

                    if (in_array($o['status'], Model_Order::STATUSGROUP_OVERDUE)) {
                        $overdue_order_id = $o['id'];
                        $overdue_num++;
                    } else {
                        $o['expire_time'] < (time() + 86400 * $this->note_repay_order_day) && $need_repay_num++;
                    }

                }
                unset($order);
            }

            if($overdue_num > 0){
                $info['button_enable'] = '1';
                $info['has_overdue_order'] = '1';
                $info['button_url'] = 'http://test.app.inst.timecash.cn/v/Loan/Detail?orderId=' . $overdue_order_id;
                $info['sub_info'] = '<!DOCTYPE html><html><body>您有 <strong>' . $overdue_num . '笔 </strong>借款 <strong>已逾期</strong></body></html>';
                $popup = [
                    'title' => '提示',
                    'msg' => '需先还清逾期账单后再借款',
                    'popup_left' => '取消',
                    'popup_right' => '去还款',
                    'url' => 'http://test.app.inst.timecash.cn/v/Loan/Detail?orderId=' . $overdue_order_id,
                ];

            }
            if($need_repay_num > 0){
                $info['sub_info'] = '<!DOCTYPE html><html><body>您' . $this->note_repay_order_day . '天内有' . $need_repay_num . '笔借款需要还款</body></html>';
            }


        }



        if ($info['button_title'] == '立即授信') {
            $info['button_enable'] = '1';
        }

        $is_login = 0;
        if (App::$_token['user_id'] > 0) {
            $is_login = '1';
        }else{
            $info['button_url'] = 'app://app.inst/User/Login';
        }


        //$info['user'] = App::$_user;
        $this->response_array = [
            'info' => $info,
            'popup' => $popup,
            //'user' => App::$_user,
            'other' => [
                'register_url' => 'app://app.inst/User/Register',
                'html_url' => '',
                'is_login' => $is_login,
            ],
        ];
        unset($info);

    }


}


