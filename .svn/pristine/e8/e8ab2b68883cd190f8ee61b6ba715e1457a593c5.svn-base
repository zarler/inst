<?php defined('SYSPATH') or die('No direct script access.');
/**
 * Created by PhpStorm.
 * User: majin
 * Date: 17/10/12
 * Time: 下午8:22
 */
class Controller_Ver1_Inst_Credit extends AppCore{
    protected $_check_token = TRUE;
    protected $_check_user = TRUE;

    protected static $order_type = Model_Order::TYPE_FAST;

    public function before() {
        parent::before(); // TODO: Change the autogenerated stub
    }

    //
    public function action_List(){


        $title = '极速贷授信列表';
        $summary = '';
        $top_button = [
            'hidden' => '1',
            'enable' => '0',
            'title' =>'下一步立即借款',
            'click' => 'app://app.timecash/AppHome/Index',
        ];
        $foot_button = [
            'hidden' => '0',
            'enable' => '0',
            'title' =>'下一步立即借款',
            'click' => 'app://app.timecash/AppHome/Index',
        ];

        $credit_list = Lib::factory('Credit_Inst')->app_id(App::$id)->credit_list(App::$_token['user_id']);
        if(!is_array($credit_list)){
            $this->response_json(['user_id'=>App::$_token['user_id']],"4000","用户授数据异常");
        }
        //遍历每一项授信,如发现未完成或者未通过项目,将按钮置亮,按钮
        foreach ($credit_list as $ci){
            if(isset($ci['status']) &&( (int)$ci['status']==Model_Credit_List::STATUS_INIT || (int)$ci['status']==Model_Credit_List::STATUS_RETRY)  ){
                $foot_button['enable'] = '1';
                $foot_button['title'] = '继续完成授信';
                $foot_button['click'] = $ci['url'];
                break;
            }
        }

        $allow_loan = FALSE;
        //检查是否有版本通过记录
        if(Lib::factory('Credit_Inst')->app_id(App::$id)->has_credit_pass(App::$_token['user_id'])){
            $allow_loan = TRUE;
        }else{
            if(Lib::factory('Credit_Inst')->app_id(App::$id)->check_credit_list(App::$_token['user_id'])===TRUE){//检查每一项是否都已通过
                Lib::factory('Credit_Inst')->app_id(App::$id)->credit_passed(App::$_token['user_id']);//授信状态记录生成
                Lib::factory('Credit_Inst')->pass_update_finance_profile(App::$_token['user_id']);//通过更新授信金额

                $allow_loan = TRUE;
                if(!Lib::factory('Credit_Inst')->app_id(App::$id)->event_credit_af(App::$_token['user_id'])){
                    $allow_loan = FALSE;
                }//授信反欺诈
            }
        }

        if($allow_loan===TRUE){
            $foot_button['enable'] = '1';
            $foot_button['title'] = '下一步立即借款';
            $foot_button['click'] = 'app://app.inst/FastLoan/Start';
        }

        if(
            //empty(App::$_user['identity_code']) ||
            //(int)App::$_user['validated_identity']!=(int)Model_User::IDENTITY_STATUS_VERIFIED ||
            (int)App::$_user['allow_login']!==(int)Model_User::ALLOW_LOGIN__ALLOWED ||
            in_array(App::$_user['status'],[Model_User::STATUS_DENY,Model_User::STATUS_LOANDENY,Model_User::STATUS_DENYFOREVER,Model_User::STATUS_DENYTEMP,Model_User::STATUS_DELETED])
        ){

            $allow_loan = FALSE;
            //用户被拒绝借款, 取消其他未完成的授信链接,不允许提交
            foreach ($credit_list as $k => $v){
                if(isset($v['status']) &&( (int)$v['status']==Model_Credit_List::STATUS_INIT || (int)$v['status']==Model_Credit_List::STATUS_RETRY)  ){
                    $credit_list[$k]['url']='';
                }
            }
            $foot_button['enable'] = '0';
            $foot_button['title'] = '资料不符，无法继续提交';
            $foot_button['click'] = 'app://app.inst/AppHome/Index';
        }
        $notice = array(
            'must'=> ['title'=>'完成以下资料才可以申请借款','icon'=>'必填项'],
            'chose' => ['title'=>'以下请至少提交一项，提交资料有助于您获得更好额度','icon'=>'']
        );

        $foot_html = '';

        $response_array = [
            'title' => $title,
            'summary' => $summary,
            'notice' => $notice,
            'credit_list' => $credit_list,
            'foot_html' => $foot_html,
            'top_button' => $top_button,
            'foot_button' => $foot_button,
        ];

        $this->response_json($response_array,"1000","授信列表");
    }





}
