<?php defined('SYSPATH') or die('No direct script access.');
/**
 * Created by PhpStorm.
 * User: majin
 * Date: 17/10/12
 * Time: 下午8:22
 */
class Controller_Ver1_Inst_Credit extends AppCore{
    protected $_check_token = TRUE;
    protected $_check_user = TRUE;

    protected static $order_type = Model_Order::TYPE_INST;

    public function before() {
        parent::before(); // TODO: Change the autogenerated stub
    }

    //
    public function action_List(){
        $title = '授信列表';
        $summary = '';
        $top_button = [
            'hidden' => '1',
            'enable' => '0',
            'title' =>'下一步立即借款',
            'click' => 'app://app.timecash/AppHome/Index',
        ];
        $foot_button = [
            'hidden' => '0',
            'enable' => '0',
            'title' =>'提交授信申请',
            'click' => 'app://app.timecash/AppHome/Index',
        ];
        $button_enable_must = TRUE;
        $button_enable_chose = TRUE;

        $credit_list = Lib::factory('Credit_Inst')->app_id(App::$id)->credit_list(App::$_token['user_id']);
        if(!is_array($credit_list)){
            $this->response_json(['user_id'=>App::$_token['user_id']],"4000","用户授数据异常");
        }
        //遍历每一项授信,如发现未完成或者未通过项目,将按钮置亮,按钮
        foreach ($credit_list['must'] as $k => $ci){
            if(isset($ci['status']) &&( (int)$ci['status']==Model_Credit_List::STATUS_INIT || (int)$ci['status']==Model_Credit_List::STATUS_RETRY)  ){
                /*                $foot_button['enable'] = '1';
                                $foot_button['title'] = '继续完成授信';
                                $foot_button['click'] = $ci['url'];
                                break;*/
                $credit_list[$k]['url'] = '';
                $button_enable_must = FALSE;
            }
        }
        foreach ($credit_list['chose'] as $k => $ci){
            if(isset($ci['status']) &&( (int)$ci['status']==Model_Credit_List::STATUS_PASS)){
                $button_enable_chose = true;
            }
        }

        if(
            //empty(App::$_user['identity_code']) ||
            //(int)App::$_user['validated_identity']!=(int)Model_User::IDENTITY_STATUS_VERIFIED ||
            (int)App::$_user['allow_login']!==(int)Model_User::ALLOW_LOGIN__ALLOWED ||
            in_array(App::$_user['status'],[Model_User::STATUS_DENY,Model_User::STATUS_LOANDENY,Model_User::STATUS_DENYFOREVER,Model_User::STATUS_DENYTEMP,Model_User::STATUS_DELETED])
        ){

            $button_enable = FALSE;
            //用户被拒绝借款, 取消其他未完成的授信链接,不允许提交
            foreach ($credit_list as $k => $v){
                if(isset($v['status']) &&( (int)$v['status']==Model_Credit_List::STATUS_INIT || (int)$v['status']==Model_Credit_List::STATUS_RETRY)  ){
                    $credit_list[$k]['url']='';
                }
            }
            $foot_button['enable'] = '0';
            $foot_button['title'] = '资料不符，无法继续提交';
            $foot_button['click'] = 'app://app.timecash/AppHome/Index';
        }

        if($button_enable_must && $button_enable_chose){
            $foot_button['enable'] = '1';
        }else{
            $foot_button['enable'] = '0';
        }
        $must = array(
            'title'=>'完成以下资料才可以申请借款',
            'icon'=>'必填项',
            'list' => isset($credit_list['must']) ? $credit_list['must']:[]
        );
        $chose = array(
            'title'=>'以下请至少提交一项，提交资料有助于您获得更好额度',
            'icon'=>'选填项',
            'list' => isset($credit_list['chose']) ? $credit_list['chose']:[]
        );

        if(in_array(App::$_user['credit_auth'], [Model_User::CREDIT_AUTH_BASE_READY, Model_User::CREDIT_AUTH_BASE_BACK])) {
            $credit_msg = array(
                'status' => '1',
                'info' => "您已提交记录，请等待审核"
            );
        }else{
            $credit_msg = array(
                'status' => '0',
                'info' => "您已提交记录，请等待审核"
            );
        }


        $order_rate_html = Lib::factory('Helper_OrderFeeRate')->html(Model_Order::TYPE_INST);
        $foot_html = $order_rate_html ? $order_rate_html : '';

        $response_array = [
            'title' => $title,
            'summary' => $summary,
            'credit_list_must' => $must,
            'credit_list_chose' => $chose,
            'foot_html' => $foot_html,
            'credit_msg' => $credit_msg,
            'top_button' => $top_button,
            'foot_button' => $foot_button,
        ];

        $this->response_json($response_array,"1000","授信列表");

    }





}
