<?php
defined('SYSPATH') or die('No direct script access.');
/**
 * Created by PhpStorm.
 * User: majin
 * Date: 16/5/31
 * Time: 上午11:11
 * 配置信息
 */
class Controller_Ver1_Settings extends AppCore{

    protected $_check_token = FALSE;
    protected $_check_user = FALSE;

    protected $_settings = array();//配置数组


    public function before() {
        parent::before(); // TODO: Change the autogenerated stub

        //CACHE ----[BEGIN]
        $ca = Lib::factory('TCCache_Settings')->uri(Request::current()->uri())->get();//CACHE GET
        if($ca){
            $response_array =$ca;
            $this->response_json($response_array,"1000","预制配置");
        }
        //CACHE ----[END]
    }


    protected function common(){
        //银行列表
        $bank = Model::factory('Bank')->get_all(Model_Bank::STATUS_VALID);
        if($bank){
            $this->_settings['bank'] = $bank;
        }


        $this->_settings['verify_code'] = Def::VERIFY_CODE;//验证码开关


        $this->_settings['home'] = [
            'selected_color' => '',
            'selected_img' => '',
            'img' => '',
            'title' => '首页',
        ];

        $this->_settings['history'] = [
            'selected_color' => '',
            'selected_img' => '',
            'img' => '',
            'title' => '还款',
        ];

        $this->_settings['profile'] = [
            'selected_color' => '',
            'selected_img' => '',
            'img' => '',
            'title' => '个人中心',
        ];


    }




    /**
     *  公用
     */
    public function action_Index(){
        $this->common();
        Lib::factory('TCCache_Settings')->uri(Request::current()->uri())->set($this->_settings);//CACHE ----- [WRITE]

        $this->_settings['_db_read'] = "1";
        $this->response_json($this->_settings,"1000","预制配置");
    }



    /**
     *  android
     */
    public function action_Android(){
        $this->common();
        $config = Kohana::$config->load('app')->get('android');
        $ver = isset($config['ver']) ? $config['ver']:'1.0' ;
        $update = isset($config['update']) ? $config['update']:'' ;
        $install = isset($config['install']) ? $config['install']:NULL ;
        $must_upgrade = isset($config['must_upgrade']) ? (string)$config['must_upgrade']:'0' ;
        $this->_settings['app']['ver'] = $ver;
        $this->_settings['app']['update'] = $update;
        $this->_settings['app']['must_upgrade'] = $must_upgrade;
        if($install){
            $this->_settings['app']['install'] = $install;
        }

        Lib::factory('TCCache_Settings')->uri(Request::current()->uri())->set($this->_settings);//CACHE ----- [WRITE]

        $this->_settings['_db_read'] = "1";
        $this->response_json($this->_settings,"1000","预制配置");
    }



    /**
     *  ios
     */
    public function action_IOS(){
        $this->common();
        $config = Kohana::$config->load('app')->get('ios');
        $ver = isset($config['ver']) ? $config['ver']:'1.0' ;
        $develop_ver = isset($config['develop_ver']) ? $config['develop_ver']:$ver ;
        $update = isset($config['update']) ? $config['update']:'' ;
        $install = isset($config['install']) ? $config['install']:NULL ;
        $must_upgrade = isset($config['must_upgrade']) ? (string)$config['must_upgrade']:'0' ;
        $this->_settings['app']['ver'] = $ver;
        $this->_settings['app']['update'] = $update;
        $this->_settings['app']['must_upgrade'] = $must_upgrade;
        $this->_settings['app']['develop_ver'] = $develop_ver;
        if($install){
            $this->_settings['app']['install'] = $install;
        }

        Lib::factory('TCCache_Settings')->uri(Request::current()->uri())->set($this->_settings);//CACHE ----- [WRITE]

        $this->_settings['_db_read'] = "1";
        $this->response_json($this->_settings,"1000","预制配置");
    }





    /**
     *  微信
     */
    public function action_Wechat(){
        $this->common();
        Lib::factory('TCCache_Settings')->uri(Request::current()->uri())->set($this->_settings);//CACHE ----- [WRITE]

        $this->_settings['_db_read'] = "1";
        $this->response_json($this->_settings,"1000","预制配置");
    }


}